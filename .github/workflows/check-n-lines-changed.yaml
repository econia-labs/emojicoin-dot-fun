---
env:
  GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
  MAX_LINES: 300
  OVERRIDE_APPROVING_REVIEWS: 2
jobs:
  check-n-lines-changed:
    runs-on: 'ubuntu-latest'
    steps:
    - uses: 'actions/checkout@v4'
      with:
        fetch-depth: 0
    - id: 'get-insertions'
      name: 'Get number of lines added'
      run: |
        git fetch origin ${{ github.base_ref }}
        INSERTIONS=$(
          git diff --stat origin/${{ github.base_ref }} | \
          tail -n1 | grep -oP '\d+(?= insertion)' || echo "0"
        )
        echo "Number of lines added: $INSERTIONS"
        echo "insertions=$INSERTIONS" >> $GITHUB_OUTPUT
    - id: 'get-deletions'
      name: 'Get number of lines removed'
      run: |
        DELETIONS=$(
          git diff --stat origin/${{ github.base_ref }} | \
          tail -n1 | grep -oP '\d+(?= deletion)' || echo "0"
        )
        echo "Number of lines removed: $DELETIONS"
        echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
    - id: 'get-approvals'
      name: 'Get number of approving reviews'
      run: |
        APPROVALS=$(
          gh pr view ${{ github.event.pull_request.number }} \
            --json reviews -q '.reviews[].state' | \
            grep -c "APPROVED" || echo "0"
        )
        echo "Number of approvals: $APPROVALS"
        echo "approvals=$APPROVALS" >> $GITHUB_OUTPUT
    - name: 'Check size versus approvals'
      run: |
        TOTAL=$((
          ${{ steps.get-insertions.outputs.insertions }} + \
          ${{ steps.get-deletions.outputs.deletions }}
        ))
        echo "Total lines changed: $TOTAL"
        if [ "$TOTAL" -gt "${{ env.MAX_LINES }}" ] && \
            [ "${{ steps.get-approvals.outputs.approvals }}" -lt \
              "${{ env.OVERRIDE_APPROVING_REVIEWS }}" ]; then
          echo "❌ Large PR ($TOTAL lines) needs ${{ env.OVERRIDE_APPROVING_REVIEWS }} approvals"
          exit 1
        elif [ "$TOTAL" -gt "${{ env.MAX_LINES }}" ]; then
          echo "✅ Large PR ($TOTAL lines) has enough approvals"
        else
          echo "✅ Small PR ($TOTAL lines)"
        fi
name: 'Check number of lines changed'
'on':
  pull_request:
    branches-ignore:
    - 'production'
    - 'fallback'
    types:
    - 'opened'
    - 'reopened'
    - 'synchronize'
...