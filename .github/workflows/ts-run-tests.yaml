# yamllint disable rule:empty-lines rule:key-ordering
# cspell:word mxschmitt

---
env:
  NEXT_PUBLIC_MODULE_ADDRESS: |-
    0xf000000d12c21b4170c7165010a4373b9ebc47bb9be9f0e48091645308a14136
  PUBLISHER_PK: |-
    0xb2e21f041ace3b049de2ef720ba6d1e1e9601c72d0d79efcbf6c476437174f10
  TS_DIR: 'src/typescript'
jobs:
  ts-run-tests:
    runs-on: 'ubuntu-latest'
    steps:
    - uses: 'actions/checkout@v4'
      with:
        submodules: 'false'
    - name: 'Install the latest Aptos CLI'
      uses: './.github/actions/get-latest-aptos-cli'
      with:
        destination_directory: '/usr/local/bin'
    - name: 'Build the docker test harness'
      run: |
        git fetch --depth 1 origin main
        git submodule update --init --recursive src/rust
        cp src/docker/example.local.env src/docker/.env && \
        bash src/sh/emojicoin/docker-test-harness.sh \
        --remove \
        --start \
        --no-frontend
      shell: 'bash'
    - uses: './.github/actions/ts-run-tests'

    # Add a tmate debugging session if the previous step fails and
    # the workflow was triggered manually.
    - name: 'Setup tmate session'
      uses: 'mxschmitt/action-tmate@v3'
      # yamllint disable-line rule:quoted-strings
      if: failure() && github.event_name == 'workflow_dispatch'
      # The tmate session is only available to whoever triggered the workflow.
      with:
        limit-access-to-actor: true

name: 'Run the TypeScript E2E and unit tests with a local testnet'
'on':
  pull_request: null
  push:
    branches:
    - 'main'
    - 'production'
  workflow_dispatch: null
...
