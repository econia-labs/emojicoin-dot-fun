%cspell:words keefer, zinsmeister

\documentclass[table, twocolumn]{article}
\usepackage{amsmath}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage[acronym]{glossaries}
\usepackage{pgfplots}
\usepackage{xcolor}
\pgfplotsset{compat=1.18}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{intersections}

% Page options.
\pagecolor{black}
\color{gray}
\geometry{left=50pt, top=50pt, bottom=50pt, right=50pt}

% Acronyms.
\newacronym{amm}{AMM}{Automated Market Maker}
\newacronym{cpamm}{CPAMM}{Constant Product Automated Market Maker}
\newacronym{clamm}{CLAMM}{Concentrated Liquidity Automated Market Maker}
\newacronym{lp}{LP}{Liquidity Provider}

% Links.
\hypersetup{colorlinks=true, allcolors={blue}}

\title{\texttt{emojicoin dot fun}}
\author{Econia Labs}
\date{}

\begin{document}

\maketitle

\section{Two-state model}

\texttt{emojicoin dot fun} bootstraps liquidity for ``fair'' (no presale, no team
allocation) emojicoin \cite{emojicoin} markets using a two-state mechanism popularized
by \texttt{pump dot fun} \cite{pump}. The first state, known as a bonding curve, uses an
abridged \gls*{clamm} with a single price range \cite{univ3}. Once the
\texttt{APT}-denominated market capitalization for an emojicoin reaches a predefined
value, a state transition occurs whereby liquidity is removed from the bonding curve and
locked into an abridged \gls*{cpamm} \cite{univ2}.

The state transition occurs at \texttt{APT}-denominated market capitalization $m_a$, for
example 10,000 \texttt{APT}. This corresponds to octa-denominated \cite{octa} market
capitalization $m_o$, as shown in equation \ref{eqn:state-transition-market-cap-apt}.

\begin{equation} \label{eqn:state-transition-market-cap-apt}
  m_o = 10^8 m_a
\end{equation}

At the state transition, the spot price resolves to $p_s$, for example 1
\texttt{APT} per emojicoin. At this point there are a predefined number of circulating
emojicoin subunits $c_s$. For simplicity emojicoins are taken to have 8 decimals, the
same as \texttt{APT}. Hence $c_s$ relates to nominal emojicoin units $c_e$ as shown
in equation \ref{eqn:state-transition-supply-emojicoin}.

\begin{equation} \label{eqn:state-transition-supply-emojicoin}
  c_s = 10^8 c_e
\end{equation}

To summarize, liquidity mechanics are fully prescribed by the variables in table
\ref{tab:state-model-variables}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|}
    \hline \rowcolor{blue}
    Term                                           & Notation \\ \hline
    \texttt{APT}-denominated market capitalization & $m_a$    \\ \hline
    Circulating emojicoin supply                   & $c_e$    \\ \hline
    \texttt{APT}-denominated spot price            & $p_s$    \\ \hline
  \end{tabular}
  \caption{Liquidity variables, at time of state transition}
  \label{tab:state-model-variables}
\end{table}


\section{Bonding curve}

The bonding curve is represented by a \gls*{clamm}, which functions as a \gls*{cpamm}
within the price range $[p_l, p_h]$ as defined by table
\ref{tab:clamm-curve-translation}, equation \ref{eqn:clamm-curve-translation}, and
figure \ref{fig:clamm-curve-translation}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|}
    \hline \rowcolor{blue}
    Term                           & Notation  \\ \hline
    Real base reserves             & $b_r$     \\ \hline
    Real quote reserves            & $q_r$     \\ \hline
    Virtual base reserves          & $b_v$     \\ \hline
    Virtual quote reserves         & $q_v$     \\ \hline
    Liquidity                      & $L$       \\ \hline
    Low price range endpoint       & $p_l$     \\ \hline
    High price range endpoint      & $p_h$     \\ \hline
    Real base reserves ceiling     & $b_{r,c}$ \\ \hline
    Real quote reserves ceiling    & $q_{r,c}$ \\ \hline
    Virtual base reserves ceiling  & $b_{v,c}$ \\ \hline
    Virtual quote reserves ceiling & $q_{v,c}$ \\ \hline
    Virtual base reserves floor    & $b_{v,f}$ \\ \hline
    Virtual quote reserves floor   & $q_{v,f}$ \\ \hline
  \end{tabular}
  \caption{Terms, \gls*{clamm} as a fixed-range \gls*{cpamm}}
  \label{tab:clamm-curve-translation}
\end{table}

\begin{equation} \label{eqn:clamm-curve-translation}
  (b_r + b_{v, f})(q_r + q_{v, f}) = L^2 = b_v q_v
\end{equation}

\begin{figure}[!htb]
  \centering
  \input{figures/clamm-curve-translation.tex}
  \caption{\gls*{clamm} as a fixed-range \gls*{cpamm}}
  \label{fig:clamm-curve-translation}
\end{figure}

The bonding curve initializes with real emojicoin reserves $c_e$, which represent only a
portion of total supply $s_e$. The remainder of emojicoin reserves $r_e$ is set aside
for the state transition which occurs when $q_{r, c}$ of \texttt{APT} has been deposited
into the bonding curve, per equation \ref{eqn:supply-amounts} as derived in section
\ref{sec:supply-amounts}.

\begin{equation} \label{eqn:supply-amounts}
  r_e = \frac{m_a - c_e \cdot p_s}{p_s},
  s_e = \frac{m_a}{p_s},
  q_{r, c} = m_a - c_e \cdot p_s
\end{equation}

Virtual reserves initialize per equation \ref{eqn:bonding-curve-setup} as derived in
section \ref{sec:bonding-curve-constraints}.

\begin{equation} \label{eqn:bonding-curve-setup}
  b_{v, c} = \frac{c_e ^ 2 \cdot p_s}{2 \cdot c_e \cdot p_s - m_a},
  q_{v, f} = \frac{(m_a - c_e \cdot p_s) ^ 2}{2 \cdot c_e \cdot p_s - m_a}
\end{equation}

The bonding curve price initializes to $p_l$ per equation \ref{eqn:bonding-curve-pl},
also derived in section \ref{sec:bonding-curve-constraints}.

\begin{equation} \label{eqn:bonding-curve-pl}
  p_l = \frac{(m_a - c_e \cdot p_s) ^ 2}{c_e ^ 2 \cdot p_s}
\end{equation}

During the bonding curve phase, virtual reserve amounts in the \gls*{clamm} follow a
simple constant product curve invariant for swaps, yielding equation
\ref{eqn:b-q-out-cpamm-simple} as derived in section
\ref{eqn:b-q-out-simple-derivation}.

\begin{equation} \label{eqn:b-q-out-cpamm-simple}
  b_{out} = \frac{b_0 \cdot q_{in}}{q_0 + q_{in}},
  q_{out} = \frac{b_{in} \cdot q_0}{b_0 + b_{in}}
\end{equation}

The state transition occurs when virtual reserves reach the values from equation
\ref{eqn:bonding-curve-transition}, derived in section
\ref{sec:bonding-curve-constraints}.

\begin{equation} \label{eqn:bonding-curve-transition}
  b_{v, f} = \frac{c_e \cdot (m_a - c_e \cdot p_s)}{2 \cdot c_e \cdot p_s - m_a},
  q_{v, c} = \frac{c_e \cdot p_s \cdot(m_a - c_e \cdot p_s)}
  {2 \cdot c_e \cdot p_s - m_a}
\end{equation}

\section{State transition to \gls*{cpamm}}

At the state transition, $q_{r, c}$ is withdrawn from the bonding curve and locked into
a \gls*{cpamm} together with $r_e$, thus maintaining a constant spot price throughout
the transition. This results in the minting of $L_i$ initial \gls*{lp} tokens, with
$L_i$ taken as the geometric mean of the two contributions per equation
\ref{eqn:initial-lp-tokens} as derived in section \ref{sec:initial-lp-tokens}.

\begin{equation} \label{eqn:initial-lp-tokens}
  L_i = \frac{m_a - c_e \cdot p_s}{\sqrt{p_s}}
\end{equation}

\section{Actual implementation values}

Actual implementation values are given in table \ref{tab:clamm-implementation-values}.

\begin{table}[!htb]
  \centering
  \begin{tabular}{|c|c|}
    \hline \rowcolor{blue}
    Term            & Amount        \\ \hline
    $m_a$           & 10,000        \\ \hline
    $c_e = b_{r,c}$ & 750,000       \\ \hline
    $r_e$           & 250,000       \\ \hline
    $s_e$           & 1,000,000     \\ \hline
    $p_s = p_h$     & 0.01          \\ \hline
    \rule{0pt}{10pt} % https://tex.stackexchange.com/a/387263.
    $p_l$           & $0.00\bar{1}$ \\ \hline
    $q_{r,c}$       & 2,500         \\ \hline
    $q_{v,f}$       & 1,250         \\ \hline
    $q_{v,c}$       & 3,750         \\ \hline
    $b_{v,f}$       & 375,000       \\ \hline
    $b_{v,c}$       & 1,125,000     \\ \hline
    $L_i$           & 25,000        \\ \hline
  \end{tabular}
  \caption{Implementation values}
  \label{tab:clamm-implementation-values}
\end{table}

This meets the restriction from equation \ref{eqn:bonding-curve-inequality}, derived
in section \ref{sec:bonding-curve-constraints}.

\begin{equation} \label{eqn:bonding-curve-inequality}
  c_e \cdot p_s < m_a < 2 \cdot c_e \cdot p_s
\end{equation}

\section{Derivations}

\subsection{Supply amounts} \label{sec:supply-amounts}

To ensure a constant price during the state transition, a portion of emojicoin reserves
must be set aside from the initial bonding curve. At the state transition this emojicoin
remainder $r_e$ is locked into the \gls*{cpamm} together with all of the \texttt{APT}
from the bonding curve, yielding:

\begin{align} \label{eqn:remainder-1}
  p_s           & = \frac{q_{r, c}}{r_e} \nonumber \\
  p_s \cdot r_e & = q_{r, c} \nonumber             \\
  r_e           & = \frac{q_{r, c}}{p_s}
\end{align}

Define $p_s = f(m_a, c_e, r_e)$:

\begin{align} \label{eqn:remainder-2}
  p_s & = \frac{m_a}{c_e + r_e}
\end{align}

Substitute (\ref{eqn:remainder-1}) into (\ref{eqn:remainder-2}):

\begin{align} \label{eqn:remainder-3}
  p_s                                                & =
  \frac{m_a}{c_e + \frac{q_{r, c}}{p_s}} \nonumber                                 \\
  p_s \cdot \left(c_e + \frac{q_{r, c}}{p_s} \right) & = m_a \nonumber             \\
  c_e + \frac{q_{r, c}}{p_s}                         & = \frac{m_a}{p_s} \nonumber \\
  \frac{q_{r, c}}{p_s}                               & =
  \frac{m_a}{p_s} - c_e \nonumber                                                  \\
  q_{r, c}                                           & = m_a - c_e \cdot p_s
\end{align}

Note $q_{r, c}$ is only positive for:

\begin{align} \label{eqn:remainder-4}
  m_a - c_e \cdot p_s & > 0 \nonumber   \\
  m_a                 & > c_e \cdot p_s
\end{align}

Substitute (\ref{eqn:remainder-3}) into (\ref{eqn:remainder-1}):

\begin{equation} \label{eqn:remainder-5}
  r_e = \frac{m_a - c_e \cdot p_s}{p_s}
\end{equation}

Hence total supply $s_e$ evaluates to:

\begin{align} \label{eqn:remainder-6}
  s_e & = c_e + r_e \nonumber                                                   \\
  s_e & = c_e + \frac{m_a - c_e \cdot p_s}{p_s} \nonumber                       \\
  s_e & = \frac{c_e \cdot p_s}{p_s} + \frac{m_a - c_e \cdot p_s}{p_s} \nonumber \\
  s_e & = \frac{c_e \cdot p_s + m_a - c_e \cdot p_s}{p_s} \nonumber             \\
  s_e & = \frac{m_a}{p_s}
\end{align}

\subsection{Bonding curve amounts} \label{sec:bonding-curve-constraints}

Evaluated at $p_l$, (\ref{eqn:clamm-curve-translation}) reduces to:

\begin{equation} \label{eqn:bonding-curve-1}
  (b_{r, c} + b_{v, f}) \cdot q_{v, f} = L^2
\end{equation}

Likewise, (\ref{eqn:clamm-curve-translation}) evaluated at $p_h$ reduces to:

\begin{equation} \label{eqn:bonding-curve-2}
  b_{v, f} \cdot (q_{r, c} + q_{v, f}) = L^2
\end{equation}

For $b_{r, c} = c_e$, combining (\ref{eqn:remainder-3}),
(\ref{eqn:bonding-curve-1}), and (\ref{eqn:bonding-curve-2}) yields:

\begin{align} \label{eqn:bonding-curve-3}
  (b_{r, c} + b_{v, f}) \cdot q_{v, f}              & =
  b_{v, f} \cdot (q_{r, c} + q_{v, f}) \nonumber              \\
  b_{r, c} \cdot q_{v, f} + b_{v, f} \cdot q_{v, f} & =
  b_{v, f} \cdot q_{r, c} + b_{v, f} \cdot q_{v, f} \nonumber \\
  b_{r, c} \cdot q_{v, f}                           & =
  b_{v, f} \cdot q_{r, c} \nonumber                           \\
  q_{v, f}                                          & =
  \frac{b_{v, f} \cdot q_{r, c}}{b_{r, c}} \nonumber          \\
  q_{v, f}                                          & =
  \frac{b_{v, f} \cdot (m_a - c_e \cdot p_s)}{c_e}
\end{align}

For $p_h = p_s$, substituting (\ref{eqn:remainder-3}) and (\ref{eqn:bonding-curve-3})
yields:

\begin{align} \label{eqn:bonding-curve-4}
  p_h                                                                   & =
  \frac{q_{v, c}}{b_{v, f}} \nonumber                                       \\
  p_s                                                                   & =
  \frac{q_{r, c} + q_{v, f}}{b_{v, f}} \nonumber                            \\
  b_{v, f} \cdot p_s                                                    & =
  q_{r, c} + q_{v, f} \nonumber                                             \\
  b_{v, f} \cdot p_s - q_{v, f}                                         & =
  q_{r, c} \nonumber                                                        \\
  b_{v, f} \cdot p_s - \frac{b_{v, f} \cdot (m_a - c_e \cdot p_s)}{c_e} & =
  m_a - c_e \cdot p_s \nonumber                                             \\
  \frac{b_{v, f} \cdot c_e \cdot p_s}{c_e} +
  \frac{b_{v, f} \cdot (c_e \cdot p_s - m_a)}{c_e}                      & =
  m_a - c_e \cdot p_s \nonumber                                             \\
  \frac{b_{v, f} \cdot (2 \cdot c_e \cdot p_s - m_a)}{c_e}              & =
  m_a - c_e \cdot p_s \nonumber                                             \\
  b_{v, f} \cdot (2 \cdot c_e \cdot p_s - m_a)                          & =
  c_e \cdot (m_a - c_e \cdot p_s) \nonumber                                 \\
  b_{v, f}                                                              & =
  \frac{c_e \cdot (m_a - c_e \cdot p_s)}{2 \cdot c_e \cdot p_s - m_a}
\end{align}

Since $m_a > c_e \cdot p_s$, the numerator is always positive for positive $c_e$.
However the denominator is only positive if:

\begin{align} \label{eqn:bonding-curve-5}
  2 \cdot c_e \cdot p_s - m_a & > 0 \nonumber           \\
  2 \cdot c_e \cdot p_s       & > m_a \nonumber         \\
  m_a                         & < 2 \cdot c_e \cdot p_s
\end{align}

Combining (\ref{eqn:bonding-curve-5}) and (\ref{eqn:remainder-4}) yields:

\begin{equation} \label{eqn:bonding-curve-6}
  c_e \cdot p_s < m_a < 2 \cdot c_e \cdot p_s
\end{equation}

Substituting (\ref{eqn:bonding-curve-4}) into (\ref{eqn:bonding-curve-3}) yields:

\begin{align} \label{eqn:bonding-curve-7}
  q_{v, f} & =
  \frac{\frac{c_e \cdot (m_a - c_e \cdot p_s)}{2 \cdot c_e \cdot p_s - m_a}
  \cdot (m_a - c_e \cdot p_s)}{c_e} \nonumber                                \\
  q_{v, f} & = \frac{(m_a - c_e \cdot p_s) ^ 2}{2 \cdot c_e \cdot p_s - m_a}
\end{align}

For $b_{r, c} = c_e$ and $b_{v, f}$ per (\ref{eqn:bonding-curve-4}), $b_{v, c}$ resolves
to:

\begin{align} \label{eqn:bonding-curve-8}
  b_{v, c} & = b_{r, c} + b_{v, f} \nonumber                                          \\
  b_{v, c} & =
  c_e + \frac{c_e \cdot (m_a - c_e \cdot p_s)}{2 \cdot c_e \cdot p_s - m_a} \nonumber \\
  b_{v, c} & =
  \frac{c_e \cdot (2 \cdot c_e \cdot p_s - m_a)}{2 \cdot c_e \cdot p_s - m_a} +
  \frac{c_e \cdot (m_a - c_e \cdot p_s)}{2 \cdot c_e \cdot p_s - m_a} \nonumber       \\
  b_{v, c} & =
  \frac{c_e \cdot (c_e \cdot p_s)}{2 \cdot c_e \cdot p_s - m_a} \nonumber             \\
  b_{v, c} & = \frac{c_e ^ 2 \cdot p_s}{2 \cdot c_e \cdot p_s - m_a}
\end{align}

For $q_{r, c}$ per (\ref{eqn:remainder-3}) and $q_{v, f}$ per
(\ref{eqn:bonding-curve-7}), $q_{v, c}$ resolves to:

\begin{align}
  q_{v, c} & = q_{r, c} + q_{v, f} \nonumber                                   \\
  q_{v, c} & = m_a - c_e \cdot p_s +
  \frac{(m_a - c_e \cdot p_s) ^ 2}{2 \cdot c_e \cdot p_s - m_a} \nonumber      \\
  q_{v, c} & = \frac{(2 \cdot c_e \cdot p_s - m_a) \cdot(m_a - c_e \cdot p_s)}
  {2 \cdot c_e \cdot p_s - m_a} +
  \frac{(m_a - c_e \cdot p_s) ^ 2}{2 \cdot c_e \cdot p_s - m_a} \nonumber      \\
  q_{v, c} & =
  \frac{(m_a - c_e \cdot p_s) \cdot (2 \cdot c_e \cdot p_s - m_a + m_a - c_e \cdot p_s)}
  {2 \cdot c_e \cdot p_s - m_a} \nonumber                                      \\
  q_{v, c} & = \frac{(m_a - c_e \cdot p_s) \cdot (c_e \cdot p_s)}
  {2 \cdot c_e \cdot p_s - m_a} \nonumber                                      \\
  q_{v, c} & = \frac{c_e \cdot p_s \cdot(m_a - c_e \cdot p_s)}
  {2 \cdot c_e \cdot p_s - m_a}
\end{align}

Hence for $q_{v, f}$ per (\ref{eqn:bonding-curve-7}) and $b_{v, c}$ per
(\ref{eqn:bonding-curve-8}), $p_l$ resolves to:

\begin{align}
  p_l & = \frac{q_{v, f}}{b_{v, c}} \nonumber                                  \\
  p_l & = \frac{\frac{(m_a - c_e \cdot p_s) ^ 2}{2 \cdot c_e \cdot p_s - m_a}}
  {\frac{c_e ^ 2 \cdot p_s}{2 \cdot c_e \cdot p_s - m_a}} \nonumber            \\
  p_l & = \frac{(m_a - c_e \cdot p_s) ^ 2}{c_e ^ 2 \cdot p_s}
\end{align}

\subsection{Base in and out for \gls*{cpamm} swap} \label{eqn:b-q-out-simple-derivation}

Let $b_0$ and $q_0$ represent base and quote reserves before a swap, and $b_f$ and $q_f$
represent reserves after a swap. For a feeless swap buy:

\begin{align}
  b_0 \cdot q_0                & = b_f \cdot q_f \nonumber                         \\
  b_0 \cdot q_0                & = (b_0 - b_{out}) \cdot (q_0 + q_{in}) \nonumber  \\
  b_0 \cdot q_0                & = b_0 \cdot q_0 + b_0 \cdot q_{in} - b_{out}
  \cdot q_0 - b_{out} \cdot q_{in} \nonumber                                       \\
  b_0 \cdot q_0                & = b_0 \cdot q_0 + b_0 \cdot q_{in} -
  b_{out} \cdot (q_0 + q_{in}) \nonumber                                           \\
  b_{out} \cdot (q_0 + q_{in}) & = b_0 \cdot q_{in} \nonumber                      \\
  b_{out}                      & = \frac{b_0 \cdot q_{in}}{q_0 + q_{in}} \nonumber \\
\end{align}

For a feeless swap sell:

\begin{align}
  b_0 \cdot q_0               & = b_f q_f \nonumber                               \\
  b_0 \cdot q_0               & = (b_0 + b_{in}) \cdot (q_0 - q_{out}) \nonumber  \\
  b_0 \cdot q_0               & = b_0 \cdot q_0 - b_0 \cdot q_{out} +
  b_{in} \cdot q_0 - b_{in} \cdot q_{out} \nonumber                               \\
  b_0 \cdot q_0               & = b_0 \cdot q_0 + b_{in} \cdot q_0 -
  q_{out} \cdot(b_0 + b_{in}) \nonumber                                           \\
  q_{out} \cdot(b_0 + b_{in}) & = b_{in} \cdot q_0 \nonumber                      \\
  q_{out}                     & = \frac{b_{in} \cdot q_0}{b_0 + b_{in}} \nonumber \\
\end{align}

\subsection{Initial \gls*{lp} tokens} \label{sec:initial-lp-tokens}

Define $L_i$ as the geometric mean of $q_{r, c}$ and $r_e$, substituting
(\ref{eqn:remainder-3}) and (\ref{eqn:remainder-5}):

\begin{align}
  L_i &= \sqrt{q_{r, c} \cdot r_e} \nonumber \\
  L_i &= \sqrt{(m_a - c_e \cdot p_s) \cdot \frac{m_a - c_e \cdot p_s}{p_s}} \nonumber \\
  L_i &= \sqrt{\frac{(m_a - c_e \cdot p_s) ^ 2}{p_s}} \nonumber \\
  L_i &=\frac{m_a - c_e \cdot p_s}{\sqrt{p_s}}
\end{align}

\begin{thebibliography}{}
  \bibitem{emojicoin} Emojicoins. Retrieved April 11, 2024 from
  \url{https://x.com/alnoki_/status/1776323147874119915}.
  \bibitem{pump} Pump. \url{https://www.pump.fun/board}, \url{https://x.com/pumpdotfun}.
  Retrieved April 11, 2024.
  \bibitem{univ3} Hayden Adams, Noah Zinsmeister, Moody Salem, River Keefer, and Dan
  Robinson. 2021. \emph{Uniswap v3 Core}. Retrieved April 11, 2024 from
  \url{https://uniswap.org/whitepaper-v3.pdf}.
  \bibitem{univ2} Hayden Adams, Noah Zinsmeister, and Dan Robinson. 2020. \emph{Uniswap
    v2 Core}. Retrieved April 11, 2024 from \url{https://uniswap.org/whitepaper.pdf}.
  \bibitem{octa} \url{https://aptos.dev/reference/glossary/#gas-unit-price}. Retrieved
  April 11, 2024.
\end{thebibliography}

\end{document}
