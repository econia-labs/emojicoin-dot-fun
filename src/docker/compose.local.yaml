services:
  move:
    extra_hosts:
      - "host.docker.internal:host-gateway"
    build:
      context: ../../
      dockerfile: src/docker/move/Dockerfile
    environment:
      PUBLISHER_PK: '${PUBLISHER_PK}'
      EMOJICOIN_MODULE_ADDRESS: '${EMOJICOIN_MODULE_ADDRESS}'
    depends_on:
      aptos:
        condition: service_healthy

  aptos:
    image: aptoslabs/tools:nightly
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/testnet:/testnet
    command: aptos node run-local-testnet --with-indexer-api --with-faucet --force-restart --assume-yes --bind-to 0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/"]
      interval: 2m
      timeout: 5s
      retries: 1
      start_period: 60s
      start_interval: 5s

  processor:
    depends_on:
      move:
        condition: service_completed_successfully
