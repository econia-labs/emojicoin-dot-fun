# yamllint disable rule:empty-lines rule:key-ordering rule:brackets
# cspell:word localnet
---
services:
  aptos-node:
    network_mode: 'host'
    image: 'econialabs/aptos-cli:4.1.0'
    profiles: ['localnet']
    healthcheck:
      test: [ 'bash', 'sh/healthcheck.sh' ]
      interval: '5s'
      timeout: '5s'
      retries: 10
      start_period: '60s'
    # Mount the Docker socket so that this container can start new containers.
    # Note that the containers created are not `children` but `siblings` of the
    # creating container.
    # See "The socket solution" below:
    # https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/
    volumes:
    - '/var/run/docker.sock:/var/run/docker.sock'
    entrypoint: [
      'aptos',
      'node',
      'run-localnet',
      '--with-indexer-api',
      '--force-restart',
      '--bind-to',
      '0.0.0.0'
    ]
  local-deployer:
    extra_hosts:
    - 'host.docker.internal:host-gateway'
    build:
      context: '../../'
      dockerfile: 'src/docker/local-deployer/Dockerfile'
      args:
        PUBLISHER_PRIVATE_KEY: '${PUBLISHER_PRIVATE_KEY}'
    environment:
      PUBLISHER_PRIVATE_KEY: '${PUBLISHER_PRIVATE_KEY}'
    image: 'econialabs/emojicoin-dot-fun-local-deployer:latest'
    profiles: ['localnet']
    depends_on:
      aptos-node:
        condition: 'service_healthy'
  processor:
    profiles: ['localnet']
    depends_on:
      aptos-node:
        condition: 'service_healthy'
...
