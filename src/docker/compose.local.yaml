# yamllint disable rule:empty-lines rule:key-ordering rule:brackets
# cspell:word localnet
---
services:
  aptos-node:
    network_mode: 'host'
    image: 'econialabs/aptos-cli:4.1.0'
    profiles: ["test-harness"]
    ports:
    - '50051:50051'
    - '8070:8070'
    - '8090:8090'
    - '8080:8080'
    - '8081:8081'
    healthcheck:
      test: [ 'bash', 'sh/healthcheck.sh' ]
      interval: '5s'
      timeout: '5s'
      retries: 10
      start_period: '60s'
    # In order to start the node with the indexer API; i.e., run
    # `aptos node run-localnet --with-indexer-api`, the Docker socket must
    # be mounted to the container. This mount enables the container to start a
    # new container. Note that this is *not* 'Docker-in-Docker', but rather
    # 'Docker-outside-Docker'. That is, the container can act as the host in
    # terms of creating and orchestrating other containers but still appears as
    # a sibling to the existing containers and any new containers it creates.
    volumes:
    - '/var/run/docker.sock:/var/run/docker.sock'
    entrypoint: [
      'aptos',
      'node',
      'run-localnet',
      '--with-indexer-api',
      '--force-restart',
      '--bind-to',
      '0.0.0.0'
    ]
  local-deployer:
    extra_hosts:
    - 'host.docker.internal:host-gateway'
    build:
      context: ../../
      dockerfile: 'src/docker/local-deployer/Dockerfile'
      args:
        PUBLISHER_PRIVATE_KEY: ${PUBLISHER_PRIVATE_KEY}
    environment:
      PUBLISHER_PRIVATE_KEY: ${PUBLISHER_PRIVATE_KEY}
    image: 'econialabs/emojicoin-dot-fun-local-deployer:latest'
    profiles: ["test-harness"]
    depends_on:
      aptos-node:
        condition: 'service_healthy'
  processor:
    profiles: ["test-harness"]
    depends_on:
      aptos-node:
        condition: 'service_healthy'
...
