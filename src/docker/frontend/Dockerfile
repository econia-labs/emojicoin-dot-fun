FROM node:20.12.2

RUN curl -fsSL https://get.pnpm.io/install.sh | \
    ENV="$HOME/.bashrc" SHELL="$(which bash)" bash - \
    && mv /root/.local/share/pnpm/pnpm /usr/local/bin/

COPY . .

WORKDIR /src/typescript/frontend

ARG INBOX_URL \
    HASH_SEED \
    NEXT_PUBLIC_APTOS_NETWORK \
    NEXT_PUBLIC_INTEGRATOR_ADDRESS \
    NEXT_PUBLIC_INTEGRATOR_FEE_RATE_BPS \
    NEXT_PUBLIC_IS_ALLOWLIST_ENABLED \
    NEXT_PUBLIC_MODULE_ADDRESS \
    NEXT_PUBLIC_MQTT_URL \
    NEXT_PUBLIC_REWARDS_MODULE_ADDRESS \
    REVALIDATION_TIME
ENV INBOX_URL=$INBOX_URL \
    HASH_SEED=$HASH_SEED \
    NEXT_PUBLIC_APTOS_NETWORK=$NEXT_PUBLIC_APTOS_NETWORK \
    NEXT_PUBLIC_INTEGRATOR_ADDRESS=$NEXT_PUBLIC_INTEGRATOR_ADDRESS \
    NEXT_PUBLIC_INTEGRATOR_FEE_RATE_BPS=$NEXT_PUBLIC_INTEGRATOR_FEE_RATE_BPS \
    NEXT_PUBLIC_IS_ALLOWLIST_ENABLED=$NEXT_PUBLIC_IS_ALLOWLIST_ENABLED \
    NEXT_PUBLIC_MODULE_ADDRESS=$NEXT_PUBLIC_MODULE_ADDRESS \
    NEXT_PUBLIC_MQTT_URL=$NEXT_PUBLIC_MQTT_URL \
    NEXT_PUBLIC_REWARDS_MODULE_ADDRESS=$NEXT_PUBLIC_REWARDS_MODULE_ADDRESS \
    REVALIDATION_TIME=$REVALIDATION_TIME

RUN pnpm install
RUN pnpm run build

HEALTHCHECK \
    --interval=2m \
    --timeout=1s \
    --start-period=20s \
    --start-interval=1s \
    --retries=1 \
    CMD curl -f http://localhost:3001/ || exit 1

CMD pnpm run start -H 0.0.0.0
