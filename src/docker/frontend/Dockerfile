FROM debian:bookworm-slim

RUN apk add nodejs curl \
    && wget -qO- https://get.pnpm.io/install.sh | \
       ENV="$HOME/.shrc" SHELL="$(which sh)" sh - \
    && mv /root/.local/share/pnpm/pnpm /usr/bin/

COPY . .

WORKDIR /src/typescript/frontend

RUN pnpm i

ARG INBOX_URL
ARG HASH_SEED
ARG NEXT_PUBLIC_APTOS_NETWORK
ARG NEXT_PUBLIC_INTEGRATOR_ADDRESS
ARG NEXT_PUBLIC_INTEGRATOR_FEE_RATE_BPS
ARG NEXT_PUBLIC_IS_ALLOWLIST_ENABLED
ARG NEXT_PUBLIC_MODULE_ADDRESS
ARG NEXT_PUBLIC_MQTT_URL
ARG NEXT_PUBLIC_REWARDS_MODULE_ADDRESS
ARG REVALIDATION_TIME
ENV INBOX_URL=$INBOX_URL
ENV HASH_SEED=$HASH_SEED
ENV NEXT_PUBLIC_APTOS_NETWORK=$NEXT_PUBLIC_APTOS_NETWORK
ENV NEXT_PUBLIC_INTEGRATOR_ADDRESS=$NEXT_PUBLIC_INTEGRATOR_ADDRESS
ENV NEXT_PUBLIC_INTEGRATOR_FEE_RATE_BPS=$NEXT_PUBLIC_INTEGRATOR_FEE_RATE_BPS
ENV NEXT_PUBLIC_IS_ALLOWLIST_ENABLED=$NEXT_PUBLIC_IS_ALLOWLIST_ENABLED
ENV NEXT_PUBLIC_MODULE_ADDRESS=$NEXT_PUBLIC_MODULE_ADDRESS
ENV NEXT_PUBLIC_MQTT_URL=$NEXT_PUBLIC_MQTT_URL
ENV NEXT_PUBLIC_REWARDS_MODULE_ADDRESS=$NEXT_PUBLIC_REWARDS_MODULE_ADDRESS
ENV REVALIDATION_TIME=$REVALIDATION_TIME

RUN pnpm run build

HEALTHCHECK \
    --interval=2m \
    --timeout=1s \
    --start-period=20s \
    --start-interval=1s \
    --retries=1 \
    CMD curl -f http://localhost:3001/ || exit 1

CMD pnpm run start -H 0.0.0.0
